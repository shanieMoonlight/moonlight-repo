import { } from '@nx/angular';
import { applicationGenerator } from '@nx/angular/generators';
import { formatFiles, generateFiles, names, Tree } from '@nx/devkit';
import { determineProjectNameAndRootOptions } from '@nx/devkit/src/generators/project-name-and-root-utils';
import { } from '@nx/js';
import { execSync } from 'child_process';
import * as fs from 'fs';
import * as path from 'path';
import { DemoAppGeneratorSchema, NoramlizedDemoAppGeneratorSchema } from './schema';

//##############################################//

function normalizeOptions(
  options: DemoAppGeneratorSchema
): NoramlizedDemoAppGeneratorSchema {

  const name = options.name;
  const directory = options.directory ?? name;
  const displayName = options.displayName || names(name).className;
  const displayNameShort = names(name).className;

  console.log(`names(name): `, names(name));

  return {
    ...options,
    name,
    directory: directory,
    displayName,
    displayNameShort,
    prefix: options.prefix || 'sb',
    port: options.port || 4200,
  };
}

//------------------------------//

async function addPwaSupportAsync(normalizedOptions: NoramlizedDemoAppGeneratorSchema) {

  try {
    console.log(`Adding PWA support to ${normalizedOptions.name}...`);
    execSync(`npx nx generate @angular/pwa:pwa --project=${normalizedOptions.name}`, {
      stdio: 'inherit'
    });
    console.log(`âœ… PWA support added successfully!`);

  } catch (error) {
    console.error(`Failed to add PWA support: ${error}`);
  }

}

//------------------------------//

/**
 * Replaces the default PWA icons with custom Spider-Baby logo icons
 * @param appRoot The root path of the project
 * @returns A promise that resolves when the operation is complete
 */
async function replaceDefaultPwaIcons(appRoot: string): Promise<void> {

  try {
    console.log(`Replacing default PWA icons with Spider-Baby logo icons...`);

    // Path to the generated icons directory created by PWA schematic
    const generatedIconsDir = path.join(appRoot, 'public', 'icons');
    const originalIconsDir = path.join(appRoot, 'public', 'icons-original');

    // 1. Check if generated icons folder exists
    if (!fs.existsSync(generatedIconsDir)) {
      console.log(`âš ï¸ No icons folder found at ${generatedIconsDir}. PWA may not be properly configured.`);
      return
    }

    console.log(`Removing default PWA icons from ${generatedIconsDir}...`);

    // 2. Delete the default icons generated by PWA schematic
    fs.rmSync(generatedIconsDir, { recursive: true, force: true });

    // 3. Check if we have custom icons to replace with
    if (!fs.existsSync(originalIconsDir)) {
      console.log(`âš ï¸ No custom icons found at ${originalIconsDir}. Using defaults.`);
      return
    }

    console.log(`Copying custom Spider-Baby icons to ${generatedIconsDir}...`);

    // 4. Ensure the destination directory exists
    fs.mkdirSync(path.dirname(generatedIconsDir), { recursive: true });

    // 5. Copy/rename our custom icons to the standard location
    fs.cpSync(originalIconsDir, generatedIconsDir, { recursive: true });

    // 6. Optional: Clean up the original icons folder if desired
    fs.rmSync(originalIconsDir, { recursive: true, force: true });

    console.log(`âœ… Custom PWA icons installed successfully!`);


  } catch (error) {
    console.error(`âŒ Failed to replace PWA icons: ${error}`);
    throw error; // Re-throw to handle in the calling function if needed
  }
}

//------------------------------//

export async function demoAppGenerator(
  tree: Tree,
  options: DemoAppGeneratorSchema
) {
  const normalizedOptions = normalizeOptions(options);

  // First, generate a standard Angular application
  const angularAppTask = await applicationGenerator(tree, {
    name: normalizedOptions.name,
    directory: normalizedOptions.directory, //Keep the tests and demo apps in the same directory
    style: 'scss',
    routing: true,
    strict: true,
    standalone: true,
    ssr: true,
    port: normalizedOptions.port,
    prefix: normalizedOptions.prefix,
  });

  // get the project root in the same that nx.applicationGenerator does.
  const nameAndRootOptions = await determineProjectNameAndRootOptions(tree, { ...normalizedOptions, projectType: 'application' });
  console.log(`nameAndRootOptions:`, nameAndRootOptions);

  console.log(`normalizedOptions:`, normalizedOptions);
  

  // Now add our custom demo files
  generateFiles(tree, path.join(__dirname, 'files'), nameAndRootOptions.projectRoot, normalizedOptions);

  // await formatFiles(tree);

  return async () => {
    // Execute the Angular app generation task
    await angularAppTask();

    try {
      await addPwaSupportAsync(normalizedOptions);

      // Replace the default PWA icons with our custom ones
      await replaceDefaultPwaIcons(normalizedOptions.directory);

    } catch (error) {
      console.error(`Somerthing went wrong:`, error);
    }

    console.log(`ðŸŽ‰ Demo application ${normalizedOptions.name} created successfully!`);
  };
}

//##############################################//

export default demoAppGenerator;

//##############################################//