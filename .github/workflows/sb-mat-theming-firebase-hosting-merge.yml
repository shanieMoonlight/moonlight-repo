# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools
#
# Updated to use a custom action for environment setup and caching

name: Deploy SpiderBabyMaterialTheming to Firebase Hosting on merge # Keep this name for this specific app
on:
  push:
    branches:
      - master
    # This workflow should ONLY run when SpiderBabyMaterialTheming code changes:
    paths:
      - 'apps/sb-mat-thm-demo/**' # Adjust path to your project's code
      - 'libs/packages/@spider-baby/theming/**' # Include paths to shared libraries it depends on
      - 'libs/ui/cards/**' # Include paths to shared libraries it depends on
      - 'package-lock.json'
  #   - 'functions/**' # If this project uses functions and changes to functions should trigger this build/deploy

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- Use your custom setup action ---
      - name: Setup Build Environment with Caching      
        uses: ./.github/actions/setup-build-env # Or replace @main with a tag like @v1 if you've tagged your action
        # Optional: Pass inputs if you want to override the defaults in action.yml
        with:
          node-version: '22' # Explicitly set the Node.js version
      # --- The custom action has now set up Node.js, restored caches, and installed dependencies ---

      - name: Create environments directory
        run: mkdir -p apps/sb-mat-thm-demo/src/environments
      - name: Create environment.ts from secrets
        env:
          ENVIRONMENT_PATH: 'apps/sb-mat-thm-demo/src/environments'
        run: |
            # Create or update environment.ts
            echo "export const environment = {" > $ENVIRONMENT_PATH/environment.ts
            echo "  production: false," >> $ENVIRONMENT_PATH/environment.ts
            echo "  firebaseConfig: {" >> $ENVIRONMENT_PATH/environment.ts
            echo "    apiKey: '${{ secrets.MAT_THEME_FIREBASE_API_KEY }}'," >> $ENVIRONMENT_PATH/environment.ts
            echo "    authDomain: '${{ secrets.MAT_THEME_FIREBASE_AUTH_DOMAIN }}'," >> $ENVIRONMENT_PATH/environment.ts
            echo "    projectId: '${{ secrets.MAT_THEME_FIREBASE_PROJECT_ID }}'," >> $ENVIRONMENT_PATH/environment.ts
            echo "    storageBucket: '${{ secrets.MAT_THEME_FIREBASE_STORAGE_BUCKET }}'," >> $ENVIRONMENT_PATH/environment.ts
            echo "    messagingSenderId: '${{ secrets.MAT_THEME_FIREBASE_MESSAGING_SENDER_ID }}'," >> $ENVIRONMENT_PATH/environment.ts
            echo "    appId: '${{ secrets.MAT_THEME_FIREBASE_APP_ID }}'," >> $ENVIRONMENT_PATH/environment.ts
            echo "    measurementId: '${{ secrets.MAT_THEME_FIREBASE_MEASUREMENT_ID }}'," >> $ENVIRONMENT_PATH/environment.ts
            echo "  }" >> $ENVIRONMENT_PATH/environment.ts
            echo "};" >> $ENVIRONMENT_PATH/environment.ts

            # Create or update environment.prod.ts
            echo "export const environment = {" > $ENVIRONMENT_PATH/environment.prod.ts
            echo "  production: true," >> $ENVIRONMENT_PATH/environment.prod.ts
            echo "  firebaseConfig: {" >> $ENVIRONMENT_PATH/environment.prod.ts
            echo "    apiKey: '${{ secrets.MAT_THEME_FIREBASE_API_KEY }}'," >> $ENVIRONMENT_PATH/environment.prod.ts
            echo "    authDomain: '${{ secrets.MAT_THEME_FIREBASE_AUTH_DOMAIN }}'," >> $ENVIRONMENT_PATH/environment.prod.ts
            echo "    projectId: '${{ secrets.MAT_THEME_FIREBASE_PROJECT_ID }}'," >> $ENVIRONMENT_PATH/environment.prod.ts
            echo "    storageBucket: '${{ secrets.MAT_THEME_FIREBASE_STORAGE_BUCKET }}'," >> $ENVIRONMENT_PATH/environment.prod.ts
            echo "    messagingSenderId: '${{ secrets.MAT_THEME_FIREBASE_MESSAGING_SENDER_ID }}'," >> $ENVIRONMENT_PATH/environment.prod.ts
            echo "    appId: '${{ secrets.MAT_THEME_FIREBASE_APP_ID }}'," >> $ENVIRONMENT_PATH/environment.prod.ts
            echo "    measurementId: '${{ secrets.MAT_THEME_FIREBASE_MEASUREMENT_ID }}'," >> $ENVIRONMENT_PATH/environment.prod.ts
            echo "  }" >> $ENVIRONMENT_PATH/environment.prod.ts
            echo "};" >> $ENVIRONMENT_PATH/environment.prod.ts
      
      - name: Build Angular app
        run: npx nx run spider-baby-mat-theming-demo:build --configuration=production

      - name: Rename index.csr.html to index.html
        run: npm run postbuild:spider-baby-mat-theming

      - name: List files in deploy directory
        run: ls -alR dist/apps/sb-mat-thm-demo/browser

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_SPIDERBABYMATERIALTHEMING }}
          channelId: live
          target: spider-baby-mat-theming-demo
          projectId: spiderbabymaterialtheming # Keep this projectId for this workflow (SpiderBabyMaterialTheming)
